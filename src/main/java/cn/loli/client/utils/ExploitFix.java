package cn.loli.client.utils;

import cn.loli.client.events.PacketEvent;
import net.minecraft.client.Minecraft;
import net.minecraft.network.play.client.C19PacketResourcePackStatus;
import net.minecraft.network.play.server.S27PacketExplosion;
import net.minecraft.network.play.server.S2APacketParticles;
import net.minecraft.network.play.server.S48PacketResourcePackSend;
import net.minecraft.potion.Potion;

public class ExploitFix {

    public ExploitFix(PacketEvent e) {
        if (e != null) {
            if (e.getPacket() instanceof S48PacketResourcePackSend) {
                ChatUtils.info("Receive A Request about resource pack one");
                ChatUtils.info("Hash: " + ((S48PacketResourcePackSend) e.getPacket()).getHash());
                ChatUtils.info("URL: " + ((S48PacketResourcePackSend) e.getPacket()).getURL());

                if (!((S48PacketResourcePackSend) e.getPacket()).getURL().toLowerCase().contains("resource")) {
                    ChatUtils.info("BaiPai A Nigga Check");
                    Minecraft.getMinecraft().getNetHandler().getNetworkManager().sendPacket(new C19PacketResourcePackStatus("MC", C19PacketResourcePackStatus.Action.DECLINED));
                    e.setCancelled(true);
                }
            }

            if (e.getPacket() instanceof S27PacketExplosion) {
                if (Math.abs(((S27PacketExplosion) e.getPacket()).getStrength()) > 99 ||
                        Math.abs(((S27PacketExplosion) e.getPacket()).getX()) > 99
                        || Math.abs(((S27PacketExplosion) e.getPacket()).getY()) > 99
                        || Math.abs(((S27PacketExplosion) e.getPacket()).getZ()) > 99) {
                    e.setCancelled(true);
                }
            }

            if (e.getPacket() instanceof S2APacketParticles) {
                if (Math.abs(((S2APacketParticles) e.getPacket()).getParticleSpeed()) > 10) {
                    e.setCancelled(true);
                }
                if (((S2APacketParticles) e.getPacket()).getParticleCount() > 500) {
                    e.setCancelled(true);
                }
            }
        } else {
            if (Minecraft.getMinecraft().thePlayer.isPotionActive(Potion.blindness)) {
                Minecraft.getMinecraft().thePlayer.removePotionEffect(Potion.blindness.id);
            }

            if (Minecraft.getMinecraft().thePlayer.isPotionActive(Potion.confusion)) {
                Minecraft.getMinecraft().thePlayer.removePotionEffect(Potion.confusion.id);
            }
        }

    }
}
